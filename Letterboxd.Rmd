---
title: "Letterboxd"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
editor_options: 
  chunk_output_type: console
runtime: shiny
---


```{r setup, include=FALSE}
library(flexdashboard);library(tidyverse);library(lubridate);library(shiny)
library(rdrop2);library(xml2);library(httr);library(plotly);library(zoo)

## Download diary.csv drom dropbox. NB KEEP THE NEXT TWO COMMENTED LINES
# token <- rdrop2::drop_auth()
# saveRDS(token, 'dropbox.rds')
rdrop2::drop_auth(rdstoken = 'dropbox.rds')
                  
diary <- rdrop2::drop_read_csv(file = 'R/trakt/letterboxd/diary.csv') %>% 
    as_tibble() %>% 
    select(title = Name, date = Watched.Date, rating = Rating, tags = Tags) %>% 
    mutate(date = lubridate::ymd(date)) %>% 
    arrange(desc(date))
                  
## And get any new films from the RSS feed
letFeed <- httr::GET("https://letterboxd.com/tomcopple/rss/") %>% 
    xml2::read_xml() %>% 
    xml2::xml_find_all(x = ., xpath = 'channel') %>% 
    xml2::xml_find_all(x = ., xpath = 'item') %>% 
    xml2::as_list() %>% 
    map(unlist) %>% 
    map_df(bind_rows) %>% 
    select(title = filmTitle, date = watchedDate, rating = memberRating) %>% 
    mutate(date = lubridate::ymd(date),
           rating = as.numeric(rating), 
           tags = "") %>% 
    filter(!is.na(date)) %>% 
    arrange(desc(date)) %>% 
    anti_join(diary, by = c('title', 'date', 'rating'))

let <- bind_rows(diary, letFeed) %>% arrange(desc(date))
```


Sidebar {.sidebar data-width=250}
-----------------------------------------------------------------------

```{r}
fileInput(inputId = 'uploadFile',
          label = 'Upload new diary.csv file',
          multiple = FALSE, 
          accept = '.csv')
actionButton(inputId = "apply", label = "Apply", icon = icon("play"))

rv <- reactiveValues(let = let)

# reactive({print(head(rv$let))})

observeEvent(eventExpr = input$apply,
             handlerExpr = {
               req(input$uploadFile) 
               newData <- read.csv(input$uploadFile$datapath) %>% 
                 select(title = Name, date = Watched.Date, rating = Rating, tags = Tags) %>% 
                 mutate(date = lubridate::ymd(date)) %>% 
                 arrange(desc(date))
               rv$let <- bind_rows(newData, rv$let %>% 
                                  anti_join(newData, by = c('title', 'date', 'rating')))
               rdrop2::drop_upload(file = input$uploadFile$datapath,
                                   path = 'R/trakt/letterboxd',
                                   mode = 'overwrite')
               
             }, ignoreNULL = FALSE)

```


12m roll {data-width=650}
-----------------------------------------------------------------------

### Rolling 12 months

```{r}
renderPlotly({
  rv$let %>% 
    arrange(date) %>% 
    group_by(date) %>% count() %>% ungroup() %>% 
    full_join(data.frame(date = seq.Date(
        from = min(rv$let$date), to = today(), by = 'days'
    ))) %>% 
    arrange(date) %>% 
    mutate(n = replace_na(n, 0)) %>% 
    mutate(rollsum = c(cumsum(n[0:364]),
                       zoo::rollsum(n, k = 365, align = 'right'))) %>% 
    filter(date >= "2012-01-01") %>% 
    plot_ly(x = ~date, y = ~rollsum, mode = "lines") %>% 
    plotly::layout(xaxis = list(title = NA),
                   yaxis = list(title = "Films per year"))
})
```

Chart 2: circles 
-----------------------------------------------------------------------

### Where

```{r}
renderPlotly({
  plotData <- rv$let %>% 
    # plotData <- let %>% 
  # filter(year(date) == 2010) %>%
  arrange(desc(date)) %>% 
  mutate(rating = rating * 2) %>%
  mutate(where = case_when(
    str_detect(tags, 'home') ~ "Home",
    str_detect(tags, 'mv') ~ "Cinema",
    str_detect(tags, 'plane') ~ "Plane",
    tags == "" ~ "N/A",
    TRUE ~ "Other"
  )) %>%
      mutate(tags = str_remove_all(tags, 'mv'),
             tags = str_remove_all(tags, 'home'),
             tags = str_remove_all(tags, '^, '),
             tags = str_remove_all(tags, ', $'),
             tags = str_replace_all(tags, ', , ', ', ')
      ) %>% 
      mutate(tags = str_to_sentence(tags)) %>% 
  mutate(where = forcats::fct_infreq(where)) %>% 
  group_by(title) %>% 
  arrange(date) %>% 
  mutate(n = row_number()) %>% 
  ungroup() %>% 
  mutate(rewatch = ifelse(
    n == 1, TRUE, FALSE
  ))
p <- plot_ly(plotData %>% filter(rewatch), 
        x = ~date, y = ~rating, type = 'scatter', mode = 'markers', 
        opacity = 0.6,
        color = ~where, legendgroup = ~where,
          marker = list(size = 25),
          text = ~str_c(title, '<br>', tags), hoverinfo = 'text') %>% 
  add_trace(data = plotData %>% filter(!rewatch),opacity = 0.25,
            x = ~date, y = ~rating, color = ~where, legendgroup = ~where,
            marker = list(size = 25), showlegend = FALSE,
          text = ~title, hoverinfo = 'text')
p %>% 
  plotly::layout(xaxis = list(title = NA),
                 yaxis = list(title = "Rating"))
})
```

Row
-----------------------------------------------------------------------

### Cinema Top 5

```{r}
renderPlotly({
  tags <- rv$let %>% 
    filter(str_detect(tags, 'mv')) %>% 
    mutate(tags = str_remove_all(tags, 'mv')) %>% 
    mutate(tags = str_remove_all(tags, '^, '),
           tags = str_remove_all(tags, ', $'),
           tags = str_replace_all(tags, ', , ', ', ')) %>% 
    separate(tags, into = c('1', '2'), sep = ", ") %>% 
    select(-rating) %>% 
    gather(-date, -title, key = key, value = value) %>% 
      filter(!value %in% c('maidavale', 'hampstead', 'bakerstreet', 'screenonthegreen')) %>% 
  mutate(value = str_to_sentence(value)) %>% 
    select(-key) %>% 
    na.omit()

top5 <- tags %>% 
    count(value, sort = T) %>% 
    slice(1:5) %>% 
    pull('value')
    
mvData <- tags %>% 
  mutate(tags = forcats::fct_other(value, keep = top5, other_level = 'Others')) %>% 
  mutate(date = floor_date(date, unit = 'weeks')) %>% 
  mutate(title = ifelse(tags == 'Others', str_c(title, '<br>', value),
                        title)) %>% 
  select(-value) %>%
  add_count(date, tags) %>% 
    group_by(tags) %>% 
    group_split() %>% 
    map(~full_join(
        x = .,
        y = data.frame(date = seq.Date(from = floor_date(min(tags$date), unit = 'weeks'),
                                   to = today(), by = 'weeks'))
    )) %>% 
    map(arrange, date) %>% 
    map(mutate, n2 = replace_na(n, 0)) %>% 
    map(fill, tags, .direction = 'updown') %>% 
  # map(mutate, smooth = predict(loess(cumsum~as.numeric(date), .)))
    map(mutate, cumsum = c(n2[1:51],
                           zoo::rollsum(n2, k = 52, align = 'right'))) %>% 
  map_df(mutate, smooth = predict(loess(cumsum~as.numeric(date), span = 0.25))) %>% 
  mutate(smooth = ifelse(smooth < 0, 0, smooth)) %>% 
  mutate(cumsum = ifelse(is.na(title), NA, cumsum))

plotly::plot_ly(mvData, x = ~date, type = 'scatter', y = ~cumsum, 
                mode='markers', color = ~tags, legendgroup = ~tags,
                marker = list(size = 4, opacity = 0.4), showlegend = FALSE,
                text = ~ifelse(is.na(title), "", title), hoverinfo = 'text') %>% 
  plotly::add_lines(y = ~smooth, color = ~tags, color = ~tags, mode = 'lines',
                    legendgroup = ~tags, line = list(shape = "spline"),
                    showlegend = TRUE, hoverinfo= 'none') %>% 
  plotly::layout(yaxis = list(title = "Rolling 12 months", tick0 = 0),
                 xaxis = list(title = NA))
})
```

### At home Top 5

```{r}
renderPlotly({
  tags <- rv$let %>% 
    filter(str_detect(tags, 'home')) %>% 
    mutate(tags = str_remove_all(tags, 'home')) %>% 
    mutate(tags = str_remove_all(tags, '^, '),
           tags = str_remove_all(tags, ', $'),
           tags = str_replace_all(tags, ', , ', ', ')) %>% 
    select(-rating) %>% 
    gather(-date, -title, key = key, value = value) %>% 
  mutate(value = str_to_sentence(value)) %>% 
    select(-key) %>% 
    na.omit()

top5 <- tags %>% 
    count(value, sort = T) %>% 
    slice(1:5) %>% 
    pull('value')
    
homeData <- tags %>% 
  mutate(tags = forcats::fct_other(value, keep = top5, other_level = 'Others')) %>% 
  mutate(date = floor_date(date, unit = 'weeks')) %>% 
   mutate(title = ifelse(tags == 'Others', str_c(title, '<br>', value),
                        title)) %>% 
  select(-value) %>%
  add_count(date, tags) %>% 
    group_by(tags) %>% 
    group_split() %>% 
    map(~full_join(
        x = .,
        y = data.frame(date = seq.Date(from = floor_date(min(tags$date), unit = 'weeks'),
                                   to = today(), by = 'weeks'))
    )) %>% 
    map(arrange, date) %>% 
    map(mutate, n2 = replace_na(n, 0)) %>% 
    map(fill, tags, .direction = 'updown') %>% 
  # map(mutate, smooth = predict(loess(cumsum~as.numeric(date), .)))
    map(mutate, cumsum = c(n2[1:51],
                           zoo::rollsum(n2, k = 52, align = 'right'))) %>% 
  map_df(mutate, smooth = predict(loess(cumsum~as.numeric(date), span = 0.25))) %>% 
  mutate(smooth = ifelse(smooth < 0, 0, smooth)) %>% 
  mutate(cumsum = ifelse(is.na(title), NA, cumsum))

plotly::plot_ly(homeData, x = ~date, type = 'scatter', y = ~cumsum, 
                mode='markers', color = ~tags, legendgroup = ~tags,
                marker = list(size = 4, opacity = 0.4), showlegend = FALSE,
                text = ~ifelse(is.na(title), "", title), hoverinfo = 'text') %>% 
  plotly::add_lines(y = ~smooth, color = ~tags, color = ~tags, mode = 'lines',
                    legendgroup = ~tags, line = list(shape = "spline"),
                    showlegend = TRUE, hoverinfo= 'none') %>% 
  plotly::layout(yaxis = list(title = "Rolling 12 months", tick0 = 0),
                 xaxis = list(title = NA))
})
```


